library(nimble)
######  M-model ICAR example NIMBLE version ################
LSTd<-list(asthma = c(43, 17, 24, 2, 42, 22, 81, 115, 36, 
26, 229, 43, 17, 22, 27, 65, 43, 32, 11, 31, 38, 147, 32, 4, 
339, 5, 13, 144, 117, 1, 295, 15, 537, 144, 65, 78, 44, 87, 15, 
69, 3, 16, 74, 926, 35, 46, 189, 140, 13, 8, 26, 23, 46, 45, 
23, 73, 69, 118, 32, 1105, 41, 4, 105, 36, 30, 21, 708, 37, 168, 
14, 29, 29, 31, 19, 147, 165, 20, 73, 19, 55, 45, 22, 27, 22, 
53, 26, 165, 17, 54, 11, 3, 144, 20, 29, 10, 39, 44, 10, 29, 
15, 30, 16, 20, 16, 72, 230, 95, 25, 20, 121, 44, 32, 31, 31, 
24, 32, 26, 0, 24, 11, 338, 61, 5, 30, 23, 106, 103, 8, 34, 7, 
2, 59, 13, 39, 22, 50, 100, 74, 7, 19, 148, 27, 23, 11, 73, 44, 
68, 75, 13, 32, 28, 2, 18, 22, 146, 24, 15, 17, 38),
COPD=c(80, 2, 46, 6, 98, 40, 126, 255, 2, 66, 359, 3, 3, 69, 35, 67, 
54, 74, 25, 45, 54, 257, 56, 5, 337, 5, 69, 183, 98, 4, 380, 
40, 688, 177, 114, 84, 78, 139, 28, 143, 19, 38, 97, 573, 71, 
101, 157, 274, 27, 8, 59, 70, 105, 31, 81, 123, 265, 149, 102, 
697, 73, 7, 146, 69, 52, 28, 389, 93, 235, 21, 97, 18, 88, 24, 
394, 191, 53, 123, 41, 71, 40, 54, 19, 57, 59, 51, 89, 31, 21, 
8, 10, 162, 65, 35, 23, 35, 81, 12, 50, 23, 47, 54, 38, 29, 86, 
214, 224, 41, 35, 231, 38, 73, 71, 37, 107, 22, 53, 0, 73, 10, 
217, 140, 12, 50, 17, 238, 129, 12, 69, 9, 2, 72, 13, 64, 22, 
88, 77, 63, 20, 19, 164, 14, 31, 30, 100, 134, 155, 187, 13, 
35, 91, 10, 29, 52, 178, 31, 54, 21, 62)
, angina = c(21, 2, 
29, 0, 24, 3, 10, 27, 15, 3, 34, 9, 7, 4, 0, 12, 
9, 4, 3, 10, 11, 39, 5, 0, 8, 0, 1, 23, 4, 1, 18, 
1, 36, 11, 28, 8, 3, 15, 3, 42, 0, 5, 18, 51, 14, 
15, 7, 24, 3, 1, 1, 16, 19, 4, 16, 12, 5, 30, 11, 
80, 11, 1, 11, 37, 19, 3, 49, 6, 4, 9, 3, 2, 14, 
0, 6, 51, 4, 8, 2, 14, 3, 4, 7, 7, 4, 6, 22, 0, 
1, 4, 0, 14, 2, 0, 0, 23, 4, 1, 3, 2, 8, 5, 12, 
2, 11, 21, 12, 0, 0, 27, 11, 4, 0, 3, 2, 7, 6, 
0, 3, 0, 13, 8, 5, 1, 2, 16, 27, 1, 20, 0, 4, 17, 
3, 18, 1, 11, 5, 37, 4, 7, 19, 3, 0, 6, 24, 14, 
33, 2, 2, 7, 32, 0, 9, 2, 15, 9, 19, 4, 1))
attach(LSTd)
LSTC<-list(Eangina=c(3.386,1.514,1.957,0.783,8.53,3.028,11.307,
16.828,3.266,3.151,29.216,2.29,2.921,3.079,5.384,11.59,
4.394,3.969,1.126,8.63,1.946,19.887,11.469,2.035,44.962,
2.768,5.011,34.74,19.696,0.611,50.536,1.319,125.19,7.482,
8.282,19.578,3.086,20.727,2.428,4.152,3.025,3.721,5.397,
127.857,3.691,2.216,17.894,21.265,2.274,0.802,8.849,3.922,
4.169,2.158,4.128,19.66,17.765,26.477,4.072,172.678,5.155,
0.51,13.555,9.482,4.614,2.96,136.968,7.469,31.263,1.819,
5.344,5.239,4.533,2.14,31.655,23.793,1.903,9.862,2.479,2.467,
3.192,1.646,1.799,5.061,3.089,1.424,8.844,5.865,10.852,1.548,
2.09,18.238,4.587,4.101,2.087,2.592,5.146,1.366,4.322,1.175,
4.487,4.486,1.68,3.299,7.697,34.94,16.353,5.61,2.567,21.2,4.676,
5.364,3.228,3.042,7.634,1.836,3.74,0.465,3.034,1.379,36.92,14.813,
0.777,2.91,1.74,11.559,4.726,0.921,6.207,1.265,0.344,4.377,1.676,
2.49,2.02,8.428,7.693,5.144,1.945,1.274,11.695,1.787,1.942,3.731,
5.22,12.049,14.266,6.505,1.151,3.794,5.354,0.432,1.265,4.537,
17.141,1.645,1.972,1.913,4.148),
Easthma=c(22.7,10.15,13.12,5.25,57.19,20.3,75.81,112.82,21.89,21.13,
195.88,15.35,19.59,20.64,36.1,77.7,29.46,26.61,7.55,57.86,13.05,133.34,
76.89,13.64,301.45,18.56,33.6,232.92,132.06,4.1,338.83,8.85,839.36,50.17,
55.53,131.26,20.69,138.97,16.28,27.84,20.28,24.95,36.19,857.24,24.75,
14.86,119.97,142.58,15.24,5.38,59.33,26.3,27.95,14.47,27.67,131.82,119.11,
177.52,27.3,1157.75,34.56,3.42,90.88,63.57,30.94,19.84,918.33,50.08,209.61,
12.19,35.83,35.12,30.39,14.35,212.23,159.53,12.76,66.12,16.62,16.54,21.4,
11.04,12.06,33.93,20.71,9.55,59.3,39.32,72.76,10.38,14.01,122.28,30.76,27.49,
13.99,17.38,34.51,9.16,28.98,7.87,30.08,30.07,11.26,22.12,51.6,234.26,109.64,
37.61,17.21,142.14,31.35,35.96,21.65,20.39,51.18,12.31,25.07,3.12,20.34,9.24,
247.54,99.32,5.21,19.51,11.67,77.5,31.69,6.17,41.62,8.48,2.31,29.35,11.24,16.7,
13.54,56.51,51.58,34.49,13.04,8.54,78.41,11.98,13.02,25.01,35,80.78,95.65,43.61,
7.71,25.44,35.9,2.89,8.48,30.42,114.92,11.03,13.22,12.83,27.81),
ECOPD=c(29.26,13.09,16.91,6.77,73.71,26.17,97.71,145.42,28.22,27.23,252.47,19.79,
25.25,26.61,46.53,100.15,37.97,34.3,9.73,74.57,16.82,171.86,99.11,17.58,388.54,
23.92,43.3,300.21,170.21,5.28,436.71,11.4,1081.83,64.66,71.57,169.18,26.67,179.11,
20.98,35.88,26.14,32.16,46.64,1104.88,31.9,19.15,154.63,183.77,19.65,6.93,76.47,
33.9,36.03,18.65,35.67,169.89,153.52,228.8,35.19,1492.2,44.55,4.41,117.13,81.94,
39.87,25.58,1183.62,64.54,270.16,15.72,46.18,45.27,39.17,18.49,273.54,205.61,16.45,
85.22,21.43,21.32,27.58,14.23,15.54,43.73,26.69,12.31,76.43,50.68,93.78,13.38,18.06,
157.6,39.64,35.43,18.04,22.4,44.47,11.81,37.35,10.15,38.77,38.76,14.52,28.51,66.51,
301.94,141.32,48.48,22.18,183.2,40.41,46.35,27.9,26.28,65.97,15.87,32.32,4.02,26.22,
11.91,319.05,128.01,6.72,25.15,15.04,99.88,40.84,7.96,53.64,10.93,2.98,37.83,14.48,
21.52,17.46,72.84,66.48,44.45,16.81,11.01,101.07,15.44,16.78,32.24,45.11,104.12,123.28,
56.21,9.94,32.79,46.27,3.73,10.93,39.2,148.12,14.21,17.04,16.53,35.85))
attach(LSTC)
Nareas=159
O<-matrix(nrow=Nareas,ncol=3)
E<-matrix(nrow=Nareas,ncol=3)
for(i in 1:Nareas){
O[i,1]<-asthma[i]
O[i,2]<-COPD[i]
O[i,3]<-angina[i]
E[i,1]<-Easthma[i]
E[i,2]<-ECOPD[i]
E[i,3]<-Eangina[i]
}	
MMcode<-nimbleCode({


	# Likelihood
	
	for (i in 1:Nareas) {
		
		for (k in 1:Ndiseases) {
			
			O[i, k] ~ dpois(lambda[i, k])
			
			log(lambda[i, k]) <- log(E[i, k]) + mu[k] + Theta[i,k]
  			
			RR[i,k] <- exp(mu[k] + Theta[i,k])
		
		}
  	
	}

	
	for (i in 1:Nareas){
		
		for(k in 1:Ndiseases){
			
			Theta[i,k]<-inprod(tPhi[1:6,i],M[1:6,k])
		
		}
	
	}

for (l1 in 1:sumNumNeigh){weights[l1]<-1}
	#### Matrix of spatially correlated random effects:
	#### if M is a square matrix define Nsp (Number of spatial underlying patterns) as Ndiseases
	for(j in 1:Nsp){
		
		Spatial[j,1:Nareas]~dcar_normal(adj[1:L],weights[1:L],num[1:Nareas],tau[j])
		
		for (i in 1:Nareas){
			
			Het[j,i]~dnorm(0,1)
			
			tPhi[j, i]<-Spatial[j,i]
		
		}
	
	} 
	for (j in (Nsp+1):(2*Nsp)){
		
		for (i in 1:Nareas){
			
			tPhi[j,i]<-Het[(j-Nsp),i]
		
		}
	
	}	
	

	#### M-matrix
	for (i in 1:(2*Nsp)){
		
		for (j in 1:Ndiseases){
			### This corresponds to the fixed effects model	

			##M[i,j]~dflat()
			### In case of implementing the random effects model comment the previous line
			### and uncomment the next one
			M[i,j] ~ dnorm(0,prec)		
		}
	}		

	###In case of implementing the random effects model uncomment the next two lines
	prec<-pow(sdstruct,-2)
	
	sdstruct~dunif(0,10)
	
for(j in 1:Nsp){tau[j]~dgamma(2,0.1)}
	

	# Other priors
	
	for (k in 1:Ndiseases){
		
		mu[k] ~ dflat()
	
	}
}
)

#################################
###### data   #######################
#################################
LSTdata<-list(O)
names(LSTdata)<-'O'
#########################################################
LSTConsts<-list(Nareas=159,Ndiseases=3,Nsp=3,E,
num = c(6, 5, 5, 6, 5, 6, 6, 7, 5, 7, 
6, 6, 6, 4, 5, 7, 5, 6, 6, 3, 
5, 6, 2, 3, 2, 5, 3, 7, 5, 4, 
5, 4, 5, 8, 6, 3, 5, 7, 5, 6, 
1, 7, 5, 5, 6, 6, 6, 4, 5, 3, 
4, 5, 10, 5, 5, 4, 4, 5, 4, 10, 
6, 4, 4, 9, 3, 6, 7, 6, 9, 7, 
3, 4, 3, 3, 6, 7, 5, 6, 6, 7, 
8, 4, 6, 7, 5, 5, 7, 5, 5, 4, 
4, 5, 6, 7, 4, 6, 7, 6, 7, 4, 
7, 7, 5, 6, 4, 3, 6, 7, 7, 6, 
5, 5, 5, 4, 4, 5, 6, 3, 2, 6, 
4, 5, 4, 4, 3, 8, 3, 4, 8, 7, 
6, 8, 7, 6, 6, 4, 6, 7, 4, 6, 
4, 6, 6, 4, 7, 5, 6, 7, 6, 6, 
7, 6, 6, 5, 4, 7, 6, 7, 7
),
adj = c(
151, 138, 132, 113, 80, 3, 
148, 86, 34, 32, 10, 
148, 113, 80, 34, 1, 
101, 100, 49, 47, 43, 19, 
158, 150, 117, 84, 70, 
127, 97, 78, 69, 68, 59, 
147, 108, 78, 69, 67, 29, 
115, 112, 110, 64, 57, 33, 28, 
156, 142, 134, 77, 34, 
137, 92, 86, 77, 37, 34, 2, 
143, 111, 102, 84, 76, 39, 
158, 143, 116, 87, 76, 45, 
151, 148, 113, 63, 24, 20, 
136, 92, 37, 35, 
89, 54, 51, 25, 16, 
124, 82, 54, 53, 51, 21, 15, 
124, 121, 82, 81, 53, 
126, 107, 102, 85, 79, 75, 
135, 120, 49, 47, 30, 4, 
63, 24, 13, 
138, 132, 54, 53, 16, 
110, 74, 71, 60, 48, 38, 
155, 146, 
148, 20, 13, 
51, 15, 
152, 130, 128, 106, 98, 
146, 64, 57, 
112, 64, 60, 58, 42, 33, 8, 
109, 108, 97, 78, 7, 
120, 118, 49, 19, 
126, 75, 60, 56, 44, 
148, 86, 50, 2, 
110, 60, 48, 28, 8, 
148, 134, 80, 77, 10, 9, 3, 2, 
159, 137, 136, 101, 37, 14, 
121, 94, 90, 
137, 92, 35, 14, 10, 
141, 126, 99, 74, 60, 56, 22, 
145, 133, 111, 102, 11, 
159, 156, 142, 129, 88, 46, 
146, 
112, 93, 69, 61, 58, 55, 28, 
125, 101, 100, 65, 4, 
122, 75, 67, 60, 31, 
156, 153, 134, 116, 87, 12, 
156, 129, 116, 96, 76, 40, 
159, 135, 101, 88, 19, 4, 
110, 60, 33, 22, 
125, 100, 30, 19, 4, 
92, 86, 32, 
124, 25, 16, 15, 
157, 109, 97, 90, 73, 
140, 138, 132, 103, 83, 82, 81, 21, 17, 16, 
132, 89, 21, 16, 15, 
144, 105, 93, 61, 42, 
126, 60, 38, 31, 
115, 64, 27, 8, 
69, 67, 60, 42, 28, 
127, 97, 73, 6, 
67, 58, 56, 48, 44, 38, 33, 31, 28, 22, 
112, 105, 93, 64, 55, 42, 
150, 149, 81, 70, 
151, 95, 20, 13, 
155, 146, 112, 105, 61, 57, 28, 27, 8, 
136, 101, 43, 
131, 117, 109, 108, 104, 70, 
147, 122, 69, 60, 58, 44, 7, 
154, 139, 127, 119, 69, 6, 
154, 93, 78, 68, 67, 58, 42, 7, 6, 
150, 149, 131, 117, 66, 62, 5, 
115, 110, 22, 
141, 130, 106, 99, 
97, 59, 52, 
141, 38, 22, 
126, 122, 107, 44, 31, 18, 
143, 116, 111, 96, 46, 12, 11, 
142, 137, 34, 10, 9, 
108, 97, 69, 29, 7, 6, 
117, 107, 104, 102, 84, 18, 
153, 138, 134, 103, 34, 3, 1, 
150, 149, 121, 94, 83, 62, 53, 17, 
124, 53, 17, 16, 
158, 150, 140, 87, 81, 53, 
158, 143, 117, 102, 79, 11, 5, 
145, 126, 114, 102, 18, 
92, 50, 32, 10, 2, 
158, 153, 143, 140, 83, 45, 12, 
159, 135, 129, 47, 40, 
132, 95, 91, 54, 15, 
157, 94, 52, 36, 
151, 132, 95, 89, 
86, 50, 37, 14, 10, 
154, 144, 69, 61, 55, 42, 
157, 149, 131, 121, 90, 81, 36, 
151, 91, 89, 63, 
133, 129, 123, 111, 76, 46, 
109, 78, 73, 59, 52, 29, 6, 
152, 133, 130, 129, 123, 26, 
145, 141, 130, 126, 114, 72, 38, 
125, 49, 43, 4, 
159, 136, 65, 47, 43, 35, 4, 
145, 85, 84, 79, 39, 18, 11, 
153, 140, 138, 80, 53, 
147, 117, 108, 107, 79, 66, 
155, 64, 61, 55, 
130, 72, 26, 
147, 122, 104, 79, 75, 18, 
147, 109, 104, 78, 66, 29, 7, 
157, 131, 108, 97, 66, 52, 29, 
115, 71, 48, 33, 22, 8, 
133, 96, 76, 39, 11, 
64, 61, 42, 28, 8, 
151, 148, 13, 3, 1, 
145, 126, 99, 85, 
110, 71, 57, 8, 
156, 76, 46, 45, 12, 
104, 84, 79, 70, 66, 5, 
128, 120, 30, 
139, 68, 
152, 135, 128, 118, 30, 19, 
94, 81, 36, 17, 
147, 107, 75, 67, 44, 
133, 129, 98, 96, 
82, 51, 17, 16, 
100, 49, 43, 
114, 99, 85, 75, 56, 38, 31, 18, 
68, 59, 6, 
152, 120, 118, 26, 
152, 135, 123, 98, 96, 88, 46, 40, 
145, 133, 106, 99, 98, 72, 26, 
157, 149, 109, 94, 70, 66, 
151, 138, 91, 89, 54, 53, 21, 1, 
145, 130, 123, 111, 98, 96, 39, 
156, 153, 80, 45, 34, 9, 
152, 129, 120, 88, 47, 19, 
101, 65, 35, 14, 
159, 142, 77, 37, 35, 10, 
140, 132, 103, 80, 53, 21, 1, 
154, 144, 119, 68, 
153, 138, 103, 87, 83, 53, 
99, 74, 72, 38, 
159, 156, 137, 77, 40, 9, 
158, 87, 84, 76, 12, 11, 
154, 139, 93, 55, 
133, 130, 114, 102, 99, 85, 39, 
155, 64, 41, 27, 23, 
122, 108, 107, 104, 67, 7, 
113, 34, 32, 24, 13, 3, 2, 
157, 131, 94, 81, 70, 62, 
158, 83, 81, 70, 62, 5, 
132, 113, 95, 91, 63, 13, 1, 
135, 129, 128, 120, 98, 26, 
140, 134, 103, 87, 80, 45, 
144, 139, 93, 69, 68, 
146, 105, 64, 23, 
142, 134, 116, 46, 45, 40, 9, 
149, 131, 109, 94, 90, 52, 
150, 143, 87, 84, 83, 12, 5, 
142, 137, 101, 88, 47, 40, 35
),sumNumNeigh = 860,L=860)
names(LSTConsts)[4]='E'

LSTinits<-list(tau=c(0.1,0.1,0.1),sdstruct=0.1,mu=c(0,0,0),
Spatial= structure(.Data=c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
, .Dim=c(3,159)),
Het=structure(.Data=c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0), .Dim=c(3,159)),
M=structure(.Data=c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0), .Dim=c(6,3)))

############ model running ###################################
LST<-nimbleModel(code=MMcode,name="LST",constants=LSTConsts,
data=LSTdata,inits=LSTinits)
#####################################################################
######################## Compile  ######################################
CLST<-compileNimble(LST)
LSTConf<-configureMCMC(LST,monitors=CLST$getNodeNames(stochOnly=TRUE,includeData=FALSE),print=TRUE)
LSTMCMC<-buildMCMC(LSTConf)
CLSTMCMC<-compileNimble(LSTMCMC,project=LST)
niter<-20000
set.seed(1)
samples<-runMCMC(CLSTMCMC,niter=niter,nburnin=15000,nchains=1,summary=TRUE,WAIC=TRUE,samplesAsCodaMCMC=TRUE)
samples$summary
samples$WAIC

########################add monitor for Theta and RR ########
LSTConf$addMonitors(c("RR","Theta"))
LSTMCMC<-buildMCMC(LSTConf)
CLSTMCMC<-compileNimble(LSTMCMC,project=LST,resetFunctions = TRUE)
niter<-10000
set.seed(1)
samples<-runMCMC(CLSTMCMC,niter=niter,nburnin=5000,nchains=1,summary=TRUE,WAIC=TRUE,samplesAsCodaMCMC=TRUE)
library(coda)
RR<-samples$samples[,496:972]
plot(RR)    #  RR is dim 5000 x 477
geweke.plot(RR[,1])
samples$summary
samples$WAIC
RRPostM<-samples$summary[496:972,1]
RR1<-RRPostM[1:159]
RR2<-RRPostM[160:318]
RR3<-RRPostM[319:477]
############################################################

###### mapping  ############################################
setwd("C:/A_NEW_FOLDER/A_NEW_FOLDER/A_PROGRAMS/MCAR type models")
library(maptools)
library(sp)
source("fillmap.R")
Gpoly<-readSplus("Georgia_SPlus_export.txt")
plot(Gpoly)
fillmap(Gpoly,"RR asthma",RR1,n.col=5);x11()
fillmap(Gpoly,"RR COPD",RR2,n.col=5);x11()
fillmap(Gpoly,"RR angina",RR3,n.col=5)
Gcon<-data.frame(RR1,RR2,RR3)

##### using Tmap with Georgia SPlus export ###############################
library(tmap)
areaID<-as.character(seq(1:159))
area<-paste(c("grid"),areaID,sep="")
attr<-data.frame(Gcon,row.names=area)
spg<-SpatialPolygonsDataFrame(Gpoly, attr, match.ID = TRUE)
#### this qtm call prodcues common legend #############################################
labels<-c("asthma","COPD","angina")
qtm(spg,fill=c("RR1","RR2","RR3"),fill.palette="Blues",ncol=3,free.scales=FALSE)
##### or  ##########################################################
### use tm_layout with legend.outside=TRUE and separate titles  ###########################
qtm(spg,fill=c("RR1","RR2","RR3"),fill.palette="Blues",ncol=3)+tm_layout(legend.outside=TRUE,title="",panel.labels=labels)

#######   SPPLOT #########################################################################
#### here       ############################################################################# 
spplot(spg,zcol=c("RR1","RR2","RR3"),names.attr=c("asthma","COPD","angina"),col.regions=grey(seq(0.9,0.1,length=40)),layout=c(3,1))

